# ðŸš€ PRODUCTION-READY REDIS CONFIGURATION
# Based on Netflix, Twitter, and Airbnb best practices
# Optimized for: Performance, Security, Reliability

# ============================================
# NETWORK & CONNECTION
# ============================================
bind 0.0.0.0
protected-mode yes
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# ============================================
# SECURITY (CRITICAL!)
# ============================================
# Require password authentication
requirepass ${REDIS_PASSWORD}

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN ""
rename-command DEBUG ""

# Allow KEYS for monitoring but warn it's slow
# (Use SCAN in application code instead)
# rename-command KEYS ""  # Uncomment to fully block

# ============================================
# MEMORY MANAGEMENT
# ============================================
# Max memory (1GB for production, adjust based on needs)
maxmemory 1gb

# Eviction policy: LRU for all keys
# Alternatives: volatile-lru, allkeys-lfu, volatile-lfu
maxmemory-policy allkeys-lru

# Samples for LRU algorithm (higher = more accurate, more CPU)
maxmemory-samples 5

# ============================================
# PERSISTENCE (AOF + RDB)
# ============================================
# AOF (Append-Only File) - Better durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec               # Sync every second (balanced)

# AOF rewrite configuration
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
no-appendfsync-on-rewrite no

# RDB (Snapshots) - Backup strategy
save 900 1                         # Save after 900s if 1 key changed
save 300 10                        # Save after 300s if 10 keys changed
save 60 10000                      # Save after 60s if 10000 keys changed

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# ============================================
# REPLICATION (for future high availability)
# ============================================
# Uncomment when adding Redis replicas
# replicaof <master-ip> <master-port>
# masterauth <master-password>
# replica-serve-stale-data yes
# replica-read-only yes

# ============================================
# PERFORMANCE TUNING
# ============================================
# Lazy freeing (non-blocking deletes)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Active memory defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# ============================================
# SLOW LOG (for debugging)
# ============================================
slowlog-log-slower-than 10000      # Log commands slower than 10ms
slowlog-max-len 128                # Keep last 128 slow commands

# ============================================
# LATENCY MONITORING
# ============================================
latency-monitor-threshold 100      # Monitor events taking > 100ms

# ============================================
# CLIENT SETTINGS
# ============================================
maxclients 10000
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ============================================
# LOGGING
# ============================================
loglevel notice
logfile /var/log/redis/redis.log

# ============================================
# ADVANCED CONFIG
# ============================================
databases 16
always-show-logo no
notify-keyspace-events ""

# ============================================
# SAVE DIRECTORY
# ============================================
dir /data

# ============================================
# NOTES FOR PRODUCTION
# ============================================
# 1. Set REDIS_PASSWORD environment variable
# 2. Monitor slowlog regularly: SLOWLOG GET 10
# 3. Check latency: LATENCY DOCTOR
# 4. Monitor memory: INFO memory
# 5. For HA, add Redis Sentinel or Cluster
